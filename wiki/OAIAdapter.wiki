#summary OAI Adapter je nástroj umožňující registrátorům vkládat a udržovat aktuální odkazy na zveřejněné instance digitálních dokumentů s přiřazeným URN:NBN.


<wiki:toc max_depth="5" />

= OAI Adapter =
OAI Adapter je nástroj pro ulehčení vkládání a aktualizací digitálních instancí, případně registraci digitálních dokumentů. Je určen pro ty digitální knihovny, které disponují OAI-PMH rozhraním. Skládá se z těchto komponent:
 * OAI Harvester - sklízí záznamy z OAI-PMH rozhraní digitální knihovny
 * Transformer - transformuje sklizené záznamy na data pro _CZIDLO API_. Tedy na vstup operace _registrace digitálního dokumentu_ a na vstup operace _import digitální instance_. Transformace jsou realizovány pomocí technologie XSLT (verze 1.0). Jsou proto potřeba vždy dva XSLT soubory. 
 * Resolver connector - modul přistupující k _CZIDLO API_. Provádí operace _registrace DD_, _import DI_ a některé další.

= Průběh =
OAI Adapter je možné chápat jako proces, jehož jedno spuštění probíhá zjednodušeně takto:
 * Během inicializace se načtou XSL transformace ze souborů, ověří se, zda je pro určeného registrátora povolen zvolený mód registrace, apod.
 * Harvester postupně sklízí záznamy z OAI providera digitální knihovny
 * Pro každý záznam pak:
  # Sklizený záznam se transformuje jednak na vstup operace _registrace DD_, jednak na vstup operace _import DI_
  # Pokud digitální dokument není v CZIDLO nalezen, je provedena  _registrace digitálního dokumentu_, vstupem je xml dokument odvozený (transformovaný) ze záznamu z OAI.
  # Import digitální instance, deaktivace neaktuální DI.
   # Pro kombinaci DD + registrátor + digitální knihovna je nalezena DI. Ta může existovat nejvýše jedna.
   # Pokud taková DI neexistuje, je importovaná nová DI odvozená z OAI záznamu (_připravená DI_).
   # Pokud DI existuje a neliší se od _připravené DI_, pokračuje se dalším záznamem.
   # Pokud se DI liší (změna url, případně dostupnosti), je aktuální DI deaktivována a importována _připravená DI_. 

OAI Adapter tedy primárně zajišťuje aktuálnost DI. To je potřeba například v následujících situacích:
 * Změní se url digitální knihovny a proto i url na jednotlivé tituly (url je hlavní částí DI).
 * Změní se viditelnost některých záznamů. 
 * Registrátor nemá nástroje pro registraci DD. Pokud má jeho digitální knihovna OAI-PMH provider, může registrátor použít tento nástroj také k registraci DD, nejen k importu DI.

OAI Adapter prochází všechny záznamy a aktualizuje jen ty, které se změnily.

== Digram průběhu pro jeden záznam ==
_Diagram obsahuje starší terminologii - *import (digitálního dokumentu)* zde znamená *registraci digitálního dokumentu*_.
https://dl.dropboxusercontent.com/u/7787647/resolver-wiki-images/oaiAdapter_single_record.jpg

= Konfigurace =
Konfigurace pro průběh OAI Adapteru se skládá z:
 * konfigurace OAI: url, metadatový prefix, případně _OAI-PMH set_
 * údaje pro CZIDLO API: url, login, heslo, kód registrátora
 * určení XSL transformací 
  # záznam z OAI -> vstup pro registraci DD
  # záznam z OAI -> vstup pro import DI

= Transformace =
XSL transformace se používají k výrobě vstupů pro operace _registrace DD_ a _import DI_ z původních xml dokumentů získaných z OAI repozitáře. Jsou tedy vždy potřeba právě dvě transformace. 
== Příklady ==
=== Časopis Duha Moravské zemské knihovny ===
 * [http://duha.mzk.cz/oai?verb=ListRecords&metadataPrefix=oai_dc Původní záznamy poskytnuté OAI Providerem webu Duha ve formátu oai_dc]
 * [https://code.google.com/p/urnnbn-resolver-v2/source/browse/trunk/oaiAdapter/src/main/resources/cz/nkp/urnnbn/oaiadapter/stylesheets/example/oaiDuha.xml Jeden záznam]
 * Vstup operace _Registrace DD_
  # [http://code.google.com/p/urnnbn-resolver-v2/source/browse/trunk/oaiAdapter/src/main/resources/cz/nkp/urnnbn/oaiadapter/stylesheets/dc_duha_import.xsl XSL transformace]
  # [https://code.google.com/p/urnnbn-resolver-v2/source/browse/trunk/oaiAdapter/src/main/resources/cz/nkp/urnnbn/oaiadapter/stylesheets/example/ddRegistrationDuha.xml transformovaný záznam]
 * Vstup operace _Import DI_
  # [http://code.google.com/p/urnnbn-resolver-v2/source/browse/trunk/oaiAdapter/src/main/resources/cz/nkp/urnnbn/oaiadapter/stylesheets/dc_duha_digital_instance.xsl XSL transformace]
  # [https://code.google.com/p/urnnbn-resolver-v2/source/browse/trunk/oaiAdapter/src/main/resources/cz/nkp/urnnbn/oaiadapter/stylesheets/example/diImportDuha.xml transformovaný záznam]
=== Staré mapy MZK ===
 * [http://oai.mzk.cz/MoZaKi/?verb=ListRecords&metadataPrefix=marc21&set=collection:oldMaps Původní záznamy starých map ve formátu marc21 (resp. marcxml)]
 * [https://code.google.com/p/urnnbn-resolver-v2/source/browse/trunk/oaiAdapter/src/main/resources/cz/nkp/urnnbn/oaiadapter/stylesheets/example/oaiOldMaps.xml Jeden záznam]
 * Vstup operace _Registrace DD_
  # [http://code.google.com/p/urnnbn-resolver-v2/source/browse/trunk/oaiAdapter/src/main/resources/cz/nkp/urnnbn/oaiadapter/stylesheets/marc21_stmpa_import.xsl XSL transformace]
  # [https://code.google.com/p/urnnbn-resolver-v2/source/browse/trunk/oaiAdapter/src/main/resources/cz/nkp/urnnbn/oaiadapter/stylesheets/example/oaiOldMaps.xml transformovaný záznam]  
 * Vstup operace _Import DI_
  # [http://code.google.com/p/urnnbn-resolver-v2/source/browse/trunk/oaiAdapter/src/main/resources/cz/nkp/urnnbn/oaiadapter/stylesheets/marc21_stmpa_digital_instance.xsl XSL transformace]
  # [https://code.google.com/p/urnnbn-resolver-v2/source/browse/trunk/oaiAdapter/src/main/resources/cz/nkp/urnnbn/oaiadapter/stylesheets/example/diImportOldMaps.xml transformovaný záznam]
=== Periodika z Krameria MZK ===
 * [http://kramerius.mzk.cz/oaiprovider/?verb=ListRecords&metadataPrefix=oai_dc&set=periodical Záznamy z OAI Provideru Krameria ve formátu oai_dc]
 * [https://code.google.com/p/urnnbn-resolver-v2/source/browse/trunk/oaiAdapter/src/main/resources/cz/nkp/urnnbn/oaiadapter/stylesheets/example/oaiKramerius.xml Jeden záznam]
 * Vstup operace _Registrace DD_
  # [http://code.google.com/p/urnnbn-resolver-v2/source/browse/trunk/oaiAdapter/src/main/resources/cz/nkp/urnnbn/oaiadapter/stylesheets/dc_kramerius_periodical_import.xsl XSL transformace]
  # [https://code.google.com/p/urnnbn-resolver-v2/source/browse/trunk/oaiAdapter/src/main/resources/cz/nkp/urnnbn/oaiadapter/stylesheets/example/ddRegistrationKramerius.xml transformovaný záznam]
 * Vstup operace _Import DI_
  # [http://code.google.com/p/urnnbn-resolver-v2/source/browse/trunk/oaiAdapter/src/main/resources/cz/nkp/urnnbn/oaiadapter/stylesheets/dc_kramerius_periodical_digital_instance.xsl XSL transformace]
  # [https://code.google.com/p/urnnbn-resolver-v2/source/browse/trunk/oaiAdapter/src/main/resources/cz/nkp/urnnbn/oaiadapter/stylesheets/example/diImportKramerius.xml transformovaný záznam]

= Spuštění =
OAI Adapter je možné spouštět dvěma způsoby:

== na serveru (přes webové rozhraní) ==
OAI Adapter je jedním z procesů, které je možné spustit na serveru.
Spuštění probíhá přes webové rozhraní CZIDLO a je povoleno jen přihlášeným uživatelům. 
Dialog pro spouštění procesu vyžaduje zadání parametrů, jako je url OAI-PMH provideru atd. Dále je zde nutné vybrat dvě XSL transformace. Webové rozhraní CZIDLO obsahuje jednoduchou správu XSL transformací. Takže je nutné požadovanou transformaci nejprve na server nahrát a před spuštěním OAI Adapteru následně zvolit transformaci z dříve nahraných.

== lokálně ==
OAI Adapter je dostupný ve formě jar balíku, viz. sekce Download. Pro jeho spuštění je potřeba Java ve verzi alespoň 1.6. Jediným vstupním parametrem je soubor obsahující konfiguraci. 
{{{
java -jar oaiAdapter-3.0.jar /path/to/configuration.properties
}}}
resp.
{{{
java -jar oaiAdapter-3.0.jar C:\path\to\configuration.properties
}}}
Příklad konfiguračního souboru:
{{{
###################
#  OAI PROVIDER   #
###################
oaiAdapter.oai.baseUrl=http://duha-devel.mzk.cz/oai
oaiAdapter.oai.metadataPrefix=oai_dc
#nepoviné 
#oaiAdapter.oai.setSpec=collection:mollMaps

###################
#    RESOLVER     #
###################
oaiAdapter.resolver.apiUrl=resolver.nkp.cz/api
oaiAdapter.resolver.login=martin
oaiAdapter.resolver.password=*****
oaiAdapter.resolver.registrarCode=duha

##########################
#  XSL TRANSFORMATIONS   #
##########################
oaiAdapter.digDocRegistrationXsl=/home/martin/NetBeansProjects/oaiAdapter/src/main/resources/cz/nkp/urnnbn/oaiadapter/stylesheets/dc_duha_import.xsl
oaiAdapter.digInstImportXsl=/home/martin/NetBeansProjects/oaiAdapter/src/main/resources/cz/nkp/urnnbn/oaiadapter/stylesheets/dc_duha_digital_instance.xsl

######################################
#  XSD FOR RESOLVER OPERATION DATA   #
######################################
oaiAdapter.digDocRegistrationXsdUrl=http://resolver.nkp.cz/api/v3/digDocRegistration.xsd
oaiAdapter.digInstImportXsdUrl=http://resolver.nkp.cz/api/v3/digInstImport.xsd

###################
#   REPORT FILE   #
###################
oaiAdapter.reportFile=/home/martin/tmp/oaiAdapter/report.txt

}}}


 